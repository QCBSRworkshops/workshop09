---
title: "Atelier 9: Analyses multivari√©es"
subtitle: "S√©rie d'ateliers R"
author: "Centre de la Science de la Biodiversit√© du Qu√©bec"
output:
  xaringan::moon_reader:
    includes:
      in_header: qcbsR-header.html
    lib_dir: assets
    seal: true
    css: ["default", "qcbsR.css", "qcbsR-fonts.css"]
    nature:
      countIncrementalSlides: false
      beforeInit: "qcbsR-macros.js"
      highlightLines: false
---

```{r setup2, echo = FALSE}
## Setup for your presentation
knitr::opts_chunk$set(
  eval = TRUE,
  cache = TRUE,
  comment = "#",
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width=5, fig.height=5, fig.retina=3,
  fig.align = 'center'
)
options(repos=structure(c(CRAN="http://cran.r-project.org")))
```

class: inverse, center, middle

```{r install_pkgs, message=FALSE, warning=FALSE, include=FALSE, results=0}
# Standard procedure to check and install packages and their dependencies, if needed.

list.of.packages <- c("ape", "gclus", "vegan")

new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]

if(length(new.packages) > 0) {
  install.packages(new.packages, dependencies = TRUE) 
  print(paste0("The following package was installed:", new.packages)) 
} else if(length(new.packages) == 0) {
    print("All packages were already installed previously")
  }
```

# ¿ propos de cet atelier
[![badge](https://img.shields.io/static/v1?style=for-the-badge&label=repo&message=dev&color=6f42c1&logo=github)](https://github.com/QCBSRworkshops/workshop09)
[![badge](https://img.shields.io/static/v1?style=for-the-badge&label=wiki&message=09&logo=wikipedia)](https://wiki.qcbs.ca/r_atelier9)
[![badge](https://img.shields.io/static/v1?style=for-the-badge&label=Diapos&message=09&color=red&logo=html5)](https://qcbsrworkshops.github.io/workshop09/workshop09-fr/workshop09-fr.html)
[![badge](https://img.shields.io/static/v1?style=for-the-badge&label=Diapos&message=09&color=red&logo=adobe-acrobat-reader)](https://qcbsrworkshops.github.io/workshop09/workshop09-fr/workshop09-fr.pdf)
[![badge](https://img.shields.io/static/v1?style=for-the-badge&label=script&message=09&color=2a50b8&logo=r)](https://qcbsrworkshops.github.io/workshop09/workshop09-fr/workshop09-fr.R)

---

# Packages requis

* [ape](https://cran.r-project.org/package=ape)
* [gclus](https://cran.r-project.org/package=gclus)
* [vegan](https://cran.r-project.org/package=vegan)

<br>

```R
install.packages(c('ape', 'gclus', 'vegan'))
```

---
# Objectifs d'apprentissage

##### Utiliser R pour faire des ordinations sans contraintes

#### Faire un dendrogramme avec R


---

class: inverse, center, middle

# 1. Introduction
## Qu'est-ce que l'ordination?


---
# Une Dimension

Que se passe-t-il si nous voulons nous int√©resser √† la r√©ponse de diff√©rentes esp√®ces d'algues?

.center[![:scale 70%](images/algalBloom.png)]


---
# Deux Dimensions

.center[![:scale 70%](images/2dim.png)]

---
# Trois Dimensions

.center[
![:scale 70%](images/3dim.png)]


---
# 4,5,6, ou plus de Dimensions

.center[![:scale 70%](images/4dim.png)]


---
# Ordination en espace r√©duit

.center[![:scale 70%](images/Ord1.png)]

---
# Ordination en espace r√©duit


.center[![:scale 70%](images/Ord2.png)]

- L'alg√®bre matricielle est complexe et difficile √† comprendre

- Une compr√©hension g√©n√©rale est suffisante pour utiliser efficacement les m√©thodes d'ordination

---
# M√©thodes pour la recherche scientifique

--
- **Questions / Hypoth√®ses**
--

- **Design exp√©rimental**

--
- **Collecte de donn√©es**
--

- **Transformation / Distance**
--

- **Analyses**
--

- **R√©daction**
--

- **Communication**


---
class: inverse, center, middle
# 2. Exploration des donn√©es

---
# Donn√©es de poissons de la rivi√®re Doubs

.pull-left[

Donn√©es de Verneaux (1973) :
- caract√©risation des communaut√©s de poissons
- 27 esp√®ces
- 30 sites
- 11 variables environnementales

]

.pull.right[
![:scale 50%](images/DoubsRiver.png)
]

---
# Donn√©es de poissons de la rivi√®re Doubs

Chargement des donn√©es esp√®ces (`Doubs.Spe.csv`)

```{r}
spe <- read.csv("data/doubsspe.csv", row.names = 1)
spe <-  spe[-8,] # supprimer le site vide
```

Chargement des donn√©es environnementales (`Doubs.Env.csv`)

```{r}
env <- read.csv("data/doubsenv.csv", row.names = 1)
env <- env[-8,] # remove site with no data
```

.alert[Attention, n'ex√©cuter qu'une seule fois]


---
# Exporation des donn√©es

Explorer le contenu des donn√©es esp√®ces :

```{r, eval = FALSE}
names(spe) # noms des objets
dim(spe) # dimensions
str(spe) # structure des objets
summary(spe) # r√©sum√© statistique
head(spe) # 6 premi√®res lignes
```

```{r, echo = FALSE}
head(spe) # 6 premi√®res lignes
```

---
# Fr√©quences des esp√®ces

Observer la distribution de fr√©quence des esp√®ces :

```{r, fig.width=7, fig.height=4.5, echo = -1}
par(mar = c(4,4,.5,.5), cex = 1.5)
ab <- table(unlist(spe))
barplot(ab, las = 1, col = grey(5:0/5),
        xlab = "Abondance des classes", ylab = "Fr√©quence")
```

.alert[Notez la proportion de 0]

---
# Fr√©quences des esp√®ces

Combien de z√©ros?

```{r}
sum(spe == 0)
```

Quelle proportion de z√©ros?

```{r}
sum(spe == 0)/(nrow(spe)*ncol(spe))
```

---
# Richesse totale en esp√®ce

Observer le nombre d'esp√®ces pr√©sentes dans chaque site :

```{r, fig.width=10, fig.height=5, echo=-1}
par(mar = c(4,4,1,.5), cex = 1.5)
site.pre <- rowSums(spe > 0)
barplot(site.pre, main = "Richesse sp√©cifique",
        xlab = "Sites", ylab = "Nombre d'esp√®ces",
        col = "grey ", las = 1)
```

---
# Comprenez vos donn√©es!

.center[...pour choisir la transformation et la distance appropri√©e]


- Y-a-t-il beaucoup de z√©ros?

- Que veulent-ils dire?


.alert[Une mesure de 0 (e.g 0mg/L, 0¬∞C) n'est pas √©quivalent √† un 0 repr√©sentant une absence d'observation.]


---
# Avant de transformer vos donn√©es de composition des communaut√©s...

.alert[Consid√©rations importantes:]

--
- abondances/comptes/pr√©sence-absence relatives?

--
- distributions asymm√©triques ?

--
- beaucoup d'esp√®ces rares?

--
- surabondance d'esp√®ces dominantes?

--
- probl√®me de double Z√©ro?

---
# Transformer les donn√©es de composition des communaut√©s

.center[
![](images/trans1.png)]

---
# Transformer les donn√©es de composition des communaut√©s

## Exemples

Transformer des comptes en pr√©sence - absence
```{r}
library(vegan)
spec.pa <- decostand(spe, method = "pa")
```

R√©duire le poids des esp√®ces rares

```{r}
spec.hel <- decostand(spe, method = "hellinger")
spec.chi <- decostand(spe, method = "chi.square")
```

R√©duire le poids des esp√®ces abondantes

```{r}
spe.pa <- decostand(spe, method = "log")
```

---
# Donn√©es sur l'environnement

```{r, eval = FALSE}
names(env) # Names of objects
dim(env) # dimensions
str(env) # structure of objects
summary(env) # summary statistics
head(env) # first 6 rows
```

```{r}
head(env) # first 6 rows
```
Explorer la colin√©arit√© en visualisant les corr√©lations entre les variables

```{r, eval = FALSE}
pairs(env, main = "Bivariate Plots of the Environmental Data")
```


---
# Donn√©es sur l'environnement

![](images/EnvDat1.png)

---
# Standardisation

Standardiser les variables environnementales est indispensable car il est impossible de comparer des variables d'unit√©s diff√©rentes :

```{r, eval = -1}
?decostand
env.z <- decostand(env, method = "standardize")
```
Cette fonction centre-r√©duit les donn√©es pour permettre la fiabilit√© des analyses :

```{r}
apply(env.z, 2, mean)
apply(env.z, 2, sd)
```



---
class: inverse, center, middle
# 3. Similarit√© / Dissimilarit√©


---
# Mesure d'association

L'alg√©bre matricielle est au coeur de plusieurs m√©thodes d'analyses multivari√©es

.center[![](images/MatrixAlgebra.png)]

- Explorer diff√©rentes mesures de distance entre objets permet de mieux comprendre le fonctionnement de l'ordination

---
# Au-d√©l√† de la 1√®re dimension

.pull-left[

- Les jeux de donn√©es √©cologiques correspondent souvent √† de grandes matrices

- L'ordination calcule les relations entre esp√®ces, ou entre objets

- Ces relations peuvent √™tre simplifi√©es par des mesures de dissimilarit√©s
]

.pull-right[

![:scale 40%](images/PCAMatrix.png)

![:scale 40%](images/distMes.png)

![:scale 40%](images/distMat.png)
]


---
# Similarit√© / Dissimilarit√©

- Utile pour comprendre vos donn√©es
- Certains types d'ordination ou de groupement n√©cessitent des mesures appropri√©es

.center[
Similarit√©: S = 1 - D
Distance: D = 1-S]


![](images/similarity.png)

---
# Mesures de distance des communaut√©s

.pull-left[
- Euclidienne
- Manhattan
- Corde
]

.pull-right[
- Hellinger
- Chi-carr√©
- Bray-Curtis
]


--
<br/>
<br/>
<br/>

.alert[Chaque mesure est utile dans diff√©rentes situations]

---
# Comparaison des sites de la rivi√®re Doubs

La fonction `vegdist()` comprend les mesures de distances communes :

```{r, eval = FALSE}
?vegdist
```
Comment la composition des communaut√©s diff√®re-t-elle entre les 30 sites de la rivi√®re Doubs?

```{r}
spe.db.pa <- vegdist(spe, method = "bray")
```

---
# Comparaison des sites

.center[![](images/Doubs1.png)]

---
# Comparaison des sites

.center[![](images/Doubs2.png)]

---
# Visualisation d'une matrice de distances

.center[![](images/MatrxViz.png)]

---
# D√©fi #1 ![:cube]()

<br/>

Discuter avec votre voisin:

<br/>

.center[**Comment savoir si deux objets caract√©ris√©s par des donn√©es multidimensionnelles sont similaires?**]

<br/>

- Faites une liste de vos suggestions


---
# Et qu'en est-il de l'ordination?

Avec des m√©thodes d'ordination, nous ordonnons vos objets (sites) en fonction de leur similarit√©

- Plus les sites sont similaires, plus ils sont proches dans l'espace d'ordination (plus petites distances)

- En √©cologie, on calcule habituellement la similarit√© entre sites en fonction de leur composition en esp√®ces ou de leur conditions environnementales.


---
# Analyse sch√©matique des analyses multivari√©es

.center[
![:scale 70%](images/ Schema1.png)]

---
# Groupement

- Permet de mettre en lumi√®re des structures dans les donn√©es en partitionnant les objets

- Les r√©sultats sont repr√©sent√©s sous forme de dendrogramme (arbre)

- Pas une m√©thode statistique!

.center[
![:scale 80%](images/cluster1.png)]

---
# Aper√ßu de 3 m√©thodes hi√©rarchiques

<br>

- Groupement agglom√©ratif √† liens simples

<br>

- Groupement agglom√©ratif √† liens complets

<br>

- Groupement de Ward

<br>

- Les √©l√©ments de petits ensembles se regroupent en groupes plus vastes de rang sup√©rieur
   - (e.g. esp√®ces, genres, familles, ordres...)

---
# Groupement hi√©rarchique

√Ä partir d'une matrice de distances, on classe les objets en ordre croissant

![](images/Hierachic1.png)


---
# Groupement √† liens simples

.pull-left[

![:scale 50%](images/singleClust1.png)
--

]

.pull-right[

- Les deux objets les plus proches se regroupent

- Ensuite les deux objets les plus proches suivants

- et ainsi de suite.

![](images/singleClust2.png)

]

---
# Groupement √† liens complet

.pull-left[

![:scale 50%](images/compleClust1.png)

]

.pull-right[

- Les deux objets les plus proches se regroupent

- Ensuite les groupes se lient √† la distance √† laquelle les objets qu'ils contiennent sont tous li√©s

![](images/compleClust2.png)
]


---
# Comparaison

Cr√©er une matrice de distance √† partir des donn√©es de la rivi√®re Doubs transform√©es Hellinger et faire le groupement √† liens simples :

```{r, fig.width=7, echo = -1}
par(mar=c(.5,3.8,2,.5), cex = 1.5)
spe.dhe1 <- vegdist(spec.hel, method = "euclidean")
spe.dhe1.single <- hclust(spe.dhe1, method = "single")
plot(spe.dhe1.single)
```


---
# Comparaison

![](images/comparison.png)


.pull-left[

**Liens simples :**

Les objets ont tendance √† s'encha√Æner (e.g. 19,29,30,26)
]

.pull-right[

**Liens complets :**
Les groupes sont plus distincts
]

---
# Groupement de Ward

- Utilise la m√©thode des moindres carr√©s pour lier les objets
  - les groupes fusionnent de fa√ßon √† minimiser la variance intragroupe
  - √† chaque √©tape, la paire de groupes √† fusionner est celle qui r√©sulte √† la plus petite augmentation de la somme des carr√©s des √©carts intra-groupes

---
# Groupement de Ward

Faire le groupement de Ward et dessiner le dendrogramme en utilisant la racine carr√©e des distances :

```{r, fig.width=9, echo = -1}
par(mar=c(.5,3.8,2,.5), cex = 1.5)
spe.dhel.ward <- hclust(spe.dhe1, method = "ward.D2")
spe.dhel.ward$height <- sqrt(spe.dhel.ward$height)
plot(spe.dhel.ward, hang = -1) # hang = -1 aligns objects at the same level
```

---
# Groupement de Ward

```{r, fig.width=9, echo = FALSE}
par(mar=c(.5,3.8,2,.5), cex = 1.5)
plot(spe.dhel.ward, hang = -1) # hang = -1 permet d'afficher les objets sur la m√™me ligne
```
Les objets ont tendance √† former des groupes plus sph√©riques et homog√®nes

---
# Comment choisir la bonne m√©thode ?

- D√©pend de votre objectif
  - d√©montrer des gradients? des contrastes?
- Si plus d'une m√©thode semble ad√©quate, comparer les dendrogrammes
- Encore une fois : ceci **n'est pas** une m√©thode statistique
 Mais! il est possible de:
  - d√©terminer le nombre de groupe optimal
  - faire des tests statistiques sur les r√©sultats
  - combiner le groupement √† l'ordination pour distinguer des groupes de sites
---
class: inverse, center, middle
# 4. Ordination non contrainte


---
# D√©finitions

--

- **Variance:** mesure de la dispersion d'une variable $y_j$ de sa moyenne
--

- **Co-variance:** mesure de co-dispersion des variables $y_j$ et $y_i$ de leur moyenne

--
- **Corr√©lation:** mesure de la force du lien entre 2 variables : $r_{ij} = (d_{ij} / d_j x d_k)$

--
- **Valeurs propres:** proportion de variance (dispersion) repr√©sent√©e par un axe d'ordination

--
- **Orthogonalit√©:** angle droit entre 2 axes ou 2 fl√®ches, ce qui veut dire qu'ils sont ind√©pendants = non corr√©l√©s

--
- **Score:** position d'un point sur un axe. Tous les scores d'un point donnent ses coordonn√©es dans l'espace multidimensionnel. Ils peuvent √™tre utilis√©s pour d'autres analyses (e.g combinaison lin√©aire de variables mesur√©es)

--
- **Dispersion** (inertie): Mesure de la variabilit√© totale du diagramme de dispersion de l'espace multidimensionnel en fonction de son centre de gravit√©

---
# Ordination non contrainte


- √âvalue la relation **dans** un ensemble de variables (esp√®ces ou variables environnementales, et non **parmi** les ensembles, i.e analyse sous contraintes)

- Trouve les composants cl√©s de la variation entre √©chantillons, sites, esp√®ces, etc...

- R√©duit le nombre de dimensions dans les donn√©es multivari√©es sans perte d'informations consid√©rables

- Cr√©er de nouvelles variables pour des analyses ult√©rieures (comme la r√©gression)


---
# 4.1. Analyse en Composantes Principales (ACP ou PCA)

.center[
![:scale 90%](images/Ord1.png)]

- Pr√©serve, en 2 dimensions, le maximum de variation des donn√©es
- Il en r√©sulte des variables synth√©tiques orthogonales entre elles (et donc non corr√©l√©es)

---
# PCA - Ce qu'il vous faut

- Un jeu de donn√©es correspondant √† des variables r√©ponses (eg. composition de communaut√©s) OU √† des variables explicatives (e.g variables environnementales)

**PAS LES DEUX!**

.pull-left[
- √âchantillons correspondant √† des mesures du m√™me jeu de variables
- G√©n√©ralement, un jeu de donn√©es plus long que large est pr√©f√©r√©
]

.pull-right[
![:scale 80%](images/PCAMatrix.png)
]

---
# PCA - Principes

<br/><br/>


|Site|Species 1| Species 2|
|---|------|------|
|A|7|3|
|B|4|3|
|C|12|10|
|D|23|11|
|E|13|13|
|F|15|16|
|G|18|14|


.alert[Un exemple simplifi√©]

---
# PCA - Principes

.center[
![:scale 60%](images/DispPlot.png)]

.small[
.alert[En 2D, les sites seraient dispos√©s de cette fa√ßon... Notez la dispersion dans le diagramme de dispersion]]

---
# PCA - Principes

.center[
![:scale 60%](images/PCA1.png)]

.small[
.alert[La premi√®re composantes principale est celle qui maximise la variation observ√©e... la meilleure droite entre les sites]]

---
# PCA - Principes

.center[
![:scale 70%](images/PCA2.png)]
.small[
.alert[La seconde composante principale est ajout√©e perpendiculairement au premier axe]]

---
# PCA - Principes

.center[
![:scale 70%](images/PCA3.png)]

.small[Le graphique final subit une rotation afin que les deux axes correspondent aux composantes principales (et non plus aux esp√®ces)]
---
# PCA - Cas multidimensionnel

<br/><br/>

- **PC1** --> axe qui maximise la variance des points projet√©s perpendiculairement sur les axes.
- **PC2** --> doit √™tre orthogonal √† PC1, mamis sa direction maximise la variance des points projet√©s.
- **PC3** --> et ainsi de suite : orthogonale √† PC1 et PC2...

<br/>

.alert[Quand il y a plus de deux dimensions, la PCA produit un nouvel espace dans lequel tous les axes sont orthogonaux (i.e. la corr√©lation entre les axes =0) et o√π les axes sont ordonn√©s selon le pourcentage de variation des donn√©es brutes qu'ils repr√©sentent (valeur propre).]


---
# PCA - Essayons sur les donn√©es Poissons!

- La PCA (tout comme la RDA) est impl√©ment√©e par la fonction `rda()` de la librairie vegan

- Effectuer une PCA sur les abondances de poissons transform√©es Hellinger

```{r}
spe.h.pca <- rda(spec.hel)

summary(spe.h.pca)
```

---
# Fonction `rda()`

- RDA en 2 √©tapes :

  - r√©gressions multiples
  - PCA sur les valeurs r√©gress√©es

- Si on donne seulement un tableau √† la fonction `rda()`, la fonction roule une PCA sans faire les r√©gressions

.center[
.alert[ rda(Y~X) ![:faic](arrow-right) RDA

rda(Y) ou rda(X) ![:faic](arrow-right) PCA ]]

---
# PCA - Interpr√©tation des sorties

.center[
![:scale 80%](images/PCAout1.png)]

- Total de variance captur√©e par les descripteurs (ici les esp√®ces de poissons)
- Dans une PCA, la proportion "Total" et "Unconstrained" de variance captur√©e est identique

---
# PCA - Interpr√©tation des sorties

<br/>

.center[
![:scale 80%](images/PCAout2.png)
]


- Liste des valeurs propores associ√©es √† chaque Composantes Principales (ici 27 PCs sont identifi√©es, soit le nombre de dimensions des donn√©es)

<br/>

.alert[
La valeur propre est la valeur du changement dans la longueur d'un vecteur, et ici repr√©sente la quantit√© de variation captur√©e par chaque Composante Principale.
]

<br/>

.center[0.258 + 0.064 + ... = 0.5025 Variance totale captur√©e]

---
# PCA - Interpr√©tation des sorties

![:scale 70%](images/PCAout1.png)

![](images/PCAout2.png)

- Liste de la proportion de variance captur√©e par chaque Composante Principale (et la proportion cumul√©e)

<br/>

.center[51.3% de 0.5025 √©gal 0.258]

---
# PCA - Interpr√©tation des sorties

![](images/PCAout3.png)

- Il existe deux fa√ßons principales de repr√©senter une ordination en 2D... ici la sortie R nous informe que le cadrage utilis√© par d√©faut est de type 2...

<br/><br/>

--

√Ä suivre!

---
# PCA - Interpr√©tation des sorties

![](images/PCAout4.png)

- *Species* ref√®re aux colonnes de votre jeu de donn√©es, ici diff√©rentes esp√®ces de poissons
- Les scores correspondent aux coordonn√©es de chaque esp√®ce le long de chaque PC

---
# PCA - Interpr√©tation des sorties

![](images/PCAout5.png)

- *Site* r√©f√®re aux lignes de votre jeu de donn√©es, ici diff√©rentes stations d'√©chantillonnage le long de la rivi√®re,
- Les scores correspondent aux coordonn√©es de chaque site le long de chaque PC


---
# Acc√©der √† une partie de la sortie R

La sortie R est tr√®s dense, mais vous pouvez acc√©der au besoin √† des informations sp√©cifiques. Par exemple, vous pouvez extraire les valeurs propres et leur contribution √† la variance captur√©e :

```{r}
summary(spe.h.pca, display = NULL)
```

---
# Acc√©der √† une partie de la sortie R

Vous pouvez calculer les valeurs propres :

```{r}
eigen(cov(spec.hel))
```



---
# Acc√©der √† une partie de la sortie R

Vous pouvez extraire les scores (des sites ou des esp√®ces) pour r√©aliser des graphiques ou les utiliser dans de nouvelles analyses :

- Extraire le score des esp√®ces pour PC1 et PC2 :
```{r}
spe.scores <- scores(spe.h.pca,
                     display = "species",
                     choices = c(1,2))
```

- Extraire le score des sites pour PC1 et PC2 :

```{r}
site.scores <- scores(spe.h.pca,
                      display = "sites",
                      choices = c(1,2))
```

---
# S√©lection des PCs significatives

<br>

- La force de la PCA est de condenser la variance contenue dans un grand jeu de donn√©es en jeu de donn√©es synth√©tiques moins nombreuses

- Dans notre cas, 27 PCs sont identifi√©es mais seules les premi√®res contribuent de fa√ßon importante √† la variance captur√©e tandis que les autres repr√©sentent le bruit des donn√©es et peuvent √™tre √©cart√©es...

--

.alert[Comment choisir les PCs les plus importantes?]

---
# Crit√®re de Kaiser - Guttman

S√©lectionner les PCs qui capturent plus de variance que la moyenne de tous les PCs

- Extraire les valeurs propres de chaque PCs :
```{r}
ev <- spe.h.pca$CA$eig
```

- S√©lectionner les valeurs propres sup√©rieures √† la moyenne :

```{r}
ev[ev>mean(ev)]
```


---
# Crit√®re de Kaiser - Guttman (illustration)

```{r, echo = -1, fig.width=10, fig.height = 5.5}
par(mar=c(4,4,2.5,.5), cex = 1.5)
n <- length(ev)
barplot(ev, main = "Valeurs propres", col = "grey", las = 2)
abline(h = mean(ev), col = "red3", lwd = 2)
legend("topright", "Valeur propore moyenne",
       lwd = 2, col = "red3" , bty = "n")
```


---
# PCA - variables environnementales

Une PCA peut aussi √™tre effectu√©e sur les variables environnementales standardis√©es pour comparer les sites ou √©valuer les corr√©lations entre variables...

- Effectuer une PCA sur les variables environnementales standardis√©es
```{r}
env.pca <- rda(env.z)
summary(env.pca, scaling  = 2) # default
```


---
# PCA - variables environnementales

- Extraire les valeurs propres de chaque PC :
```{r}
ev <- env.pca$CA$eig
```

- S√©lectionner les valeurs propres sup√©rieures √† la moyenne :

```{r}
ev[ev>mean(ev)]
```

---
# PCA - variables environnementales

- Cr√©er le graphique :

```{r, echo = -1, fig.width=8, fig.height=4.5}
par(mar=c(4,4,2.5,.5), cex = 1.5)
n <- length(ev)
barplot(ev, main = "Eigenvalues", col = "grey", las = 2)
abline(h = mean(ev), col = "red3", lwd = 2)
legend("topright", "Average eigenvalue",
       lwd = 2, col = "red3" , bty = "n")
```

---
# PCA - Illustration graphique

L'abondante information produite par une PCA est plus facile √† comprendre et √† interpr√©ter √† l'aide de biplots permettant de visualiser les patrons pr√©sents dans les donn√©es.

- Un biplot peut √™tre rapidement cr√©√© via la fonction `plot()`

```{r, echo = -1, fig.width=7, fig.height=4}
par(mar=c(4,4,.1,.1), cex = 1.5)
plot(spe.h.pca)
```

---
# Biplot de PCA avec plot()

.center[
![:scale 70%](images/biplotPCA.png)]


.comment[
`plot()` est rapide mais il est difficile d'interpr√©ter les angles entre esp√®ces
]


---
# Basique `biplot()` de PCA

- Avec la fonction `biplot()` de base R, des fl√®ches sont trac√©es pour montrer les directions et les angles entre descripteurs dans l'ordination

.alert[
.small[
- Descripteurs distants de 180 degr√©s : corr√©lation n√©gative
- Descripteurs distants de 90 degr√©s : pas de corr√©lation
- Descripteurs distants de 0 degr√© : corr√©lation positive
]]

```{r, echo = -1, fig.height=3.5, fig.width=4.5}
par(mar = c(4,4,0.05,0.05), cex = 1.2)
biplot(spe.h.pca)
```



---
# Type de *scaling*



![:scale 95%](images/Scaling.png)


.pull_left[
.small[Cadrage 2 (DEFAULT): les distances entre objets ne sont pas des approximations de leurs distances euclidiennes, mais les angles entre descripteurs refl√®tnent leurs corr√©lations.]

.alert[
.small[**Meilleur cadrage pour interpr√©ter les relations entre descripteurs (esp√®ces) !**]]]


.pull_right[
.small[Cadrage 1 : pr√©serve au maximum la distance euclidienne (dans l'espace d'ordination) entre objets (ex. sites); les angles entre descripteurs (ex. esp√®ces) ne sont pas informatifs.]

.alert[
.small[**Meilleur cadrage pour interpr√©ter les relations entre objects (sites)!**]]]


---
# "Biplot" avanc√©s

- En extrayant certaines parties de la sortie R, il est possible de cr√©er des biplots plus d√©taill√©s et clairs :

```{r, eval = FALSE}
plot(spe.h.pca, scaling  = 1, type = "none",
     xlab = c("PC1 (%)", round(spe.h.pca$CA$eig[1]/sum(spe.h.pca$CAeig)*100,2)),
     ylab = c("PC2 (%)", round(spe.h.pca$CA$eig[2]/sum(spe.h.pca$CA$eig)*100,2)))
points(scores(spe.h.pca, display = "sites", choices = c(1,2), scaling = 1),
       pch=21, col = "black", bg = "steelblue" , cex  = 1.2)
text(scores(spe.h.pca, display = "species", choices = 1, scaling = 1),
     scores(spe.h.pca, display = "species", choices = 2, scaling = 1),
     labels = rownames(scores(spe.h.pca, display = "species", scaling = 1)),
     col = "red", cex = 0.8)
spe.cs <- scores(spe.h.pca, choices = 1:2, scaling = 1 , display = "sp")
arrows(0, 0, spe.cs[,1], spe.cs[,2], length = 0)
```

voir la fonction `arrows()` de  `graphics` pour ajouter des vecteurs


---
# "Biplot" avanc√©s

```{r, echo = F, fig.width=7,fig.height=7}
par(mar = c(4,4,0.05,0.05), cex = 1.2)
plot(spe.h.pca, scaling  = 1, type = "none",
     xlab = c("PC1 (%)", round(spe.h.pca$CA$eig[1]/sum(spe.h.pca$CAeig)*100,2)),
     ylab = c("PC2 (%)", round(spe.h.pca$CA$eig[2]/sum(spe.h.pca$CA$eig)*100,2)))
points(scores(spe.h.pca, display = "sites", choices = c(1,2), scaling = 1),
       pch=21, col = "black", bg = "steelblue" , cex  = 1.2)
text(scores(spe.h.pca, display="species", choices=c(1), scaling = 1),
     scores(spe.h.pca, display = "species", choices = c(2), scaling = 1),
     labels=rownames(scores(spe.h.pca, display = "species", scaling = 1)),
     col = "red", cex = 0.8)
spe.cs <- scores(spe.h.pca, choices = 1:2, scaling = 1 , display = "sp")
arrows(0,0,spe.cs[,1], spe.cs[,2], length = 0)
```

---
# Autres options graphiques : `ggvegan`

- Un ensemble d'outils pour cr√©er des biplots avec ggplot2 :

```{r, eval = FALSE}
install.packages("devtools")
require("devtools")
install_github("ggvegan", "gavinsimpson")
require("ggvegan")
autoplot()
```

---
# Autres options graphiques : `rgl` et `vegan3d`

Biplot interactif avec rgl

```{r, eval = FALSE}
require(rgl)
require(vegan3d)
ordirgl(spe.h.pca)
```

![](images/Vegan3d.png)
---
# D√©fi # 3 ![:cube]()
Ex√©cuter une PCA sur les donn√©es d'abondance d'acariens :

```{r}
data(mite)
```

- Quels sont les axes significatifs?
- Quels groupes de sites pouvez-vous identifier?
- Quelles esp√®ces caract√©risent ces groupes de sites?

---
# Solution #3

- Transformation Hellinger des donn√©es :

```{r}
mite.spe.hel <- decostand(mite, method = "hellinger")

mite.spe.h.pca <- rda(mite.spe.hel)
```

- Recherche des axes significatifs par crit√®re de Gutman-Kaiser :

```{r, eval = FALSE}
ev <- mite.spe.h.pca$CA$eig
ev[ev > mean(ev)]
n <- length(ev)
barplot(ev, main = "Valeurs propres", col = "grey", las = 2)
abline(h = mean(ev), col = "red3", lwd = 2)
legend("topright", "Valeur propre moyenne", lwd = 2, col = "red3", bty = "n")
```

---
# Solution #3

```{r, echo = F, fig.width=10, fig.height=7}
par(mar=c(4,4,2,1), cex = 1.2)
ev <- mite.spe.h.pca$CA$eig
n <- length(ev)
barplot(ev, main = "Valeurs propres", col = "grey", las = 2)
abline(h = mean(ev), col = "red3", lwd = 2)
legend("topright", "Valeur propre moyenne", lwd = 2, col = "red3", bty = "n")
```



---
# Solution #3

```{r, echo = -1, fig.height=6.5, fig.width=7}
par(mar = c(4,4,0.05,0.05), cex = 1.5)
biplot(mite.spe.h.pca, col = c("red3", "grey15"))
```


---
# Attention

- La PCA est une m√©thode lin√©aire bas√©e sur quelques hypoth√®se clefs :

--

  - distribution multinormale des donn√©es (seulement pour faire des inf√©rences)

--

  - nombre limit√© de z√©ros

--

  - le gradient d'int√©r√™t doit causer la majorit√© de la variance dans le jeu de donn√©es

.alert[
.small[
Le non-respect de ces hypoth√®se peut causer une forme de fer √† cheval sur les biplots (*horseshoe effect*), sur lesquels les extr√©mit√©s du fer √† cheval sont proches mais repr√©sentent en r√©alit√© des conditions oppos√©es du gradient]
]

---
# Attention

- Certains de ces probl√®mes peuvent √™tre r√©gl√©s en utilisant des transformations appropri√©es des donn√©es avant d'effectuer une PCA

- Dans certains cas, tels que les √©tudes couvrant de longs gradients environnementaux, il est pr√©f√©rable d'utiliser d'autres m√©thodes d'ordination non-contraintes (ex. CA)

---
# 4.1. Analyse des Correspondances (CA)

## Distances euclidiennes vs distances de Chi<sup>2</sup>

- La PCA pr√©serves les **distances euclidiennes** entre objets et postule une relation lin√©aire entre descripteurs

- ...mais dans certains cas (ex. gradients longs), **les esp√®ces pr√©sentent une r√©ponse unimodale** aux gradients environnementaux

---
# Principes de la CA

- Dans de tels cas, la CA devrait √™tre pr√©f√©r√©e √† la PCA car elle pr√©serve les **distances de Chi2 entre objets**... et repr√©sente donc mieux les r√©ponses unimodales

---
# Comment effectuer une CA?

- La CA est impl√©ment√©e dans la librairie `vegan` par la fonction `cca()`:

```{r}
spe.ca <- cca(spe[-8,])
# prend seulement les colonnes dont rowsums est > √† 0.

```

- CA effectu√©e sur les abondances de poissons

---
# CA: sortie de R

- Les r√©sultats d'une CA sont pr√©sent√©s de la m√™me mani√®re qu'une PCA et peuvent √™tre appel√©s par :

```{r}
summary(spe.ca)
```


---
# CA: Interpr√©tation des r√©sultats

.pull-left2[
![](images/CAInt.png)
]

.pull-right2[

26 axes CA identifi√©s

% CA1 = 51.50%

% CA2 = 12.37%
]


---
# CA: biplots

.center[
![:scale 60%](images/CABiplto.png)]

.small[
Ces biplots montrent qu'un groupe de sites (√† gauche) poss√®de des communaut√©s similaires de poissons caract√©ris√©es par de nombreuses esp√®ces dont *GAR*, *TAN*, *PER*, *ROT*, *PSO* et *CAR*

Dans le coin sup√©rieur droit, un second groupe de sites se caract√©rise par les esp√®ces *LOC*, *VAI* et *TRU*

Le dernier groupe de sites dans le coin inf√©rieur droit montre des communaut√©s abondantes en *BLA*, *CHA* et *OMB*
]


---
# D√©fi #4 ![:cube]()

Ex√©cuter une CA sur les donn√©es d'abondance des esp√®ces d'acariens

```{r}
mite.spe <- mite
```

- Quels sont les axes importants?
- Quels groupes de sites se distinguent?
- Quelles esp√®ces caract√©risent chaque groupe de site?

---
# Solution #4

- Calcule de la CA:

```{r}
mite.spe.ca <- cca(mite.spe)
```

- Recherche des axes significatifs par crit√®re de Guttman-Kaiser :

```{r, eval = FALSE}
ev <- mite.spe.ca$CA$eig
ev[ev > mean(ev)]
n <- length(ev)
barplot(ev, main = "Valeurs propres", col = "grey", las = 2)
abline(h = mean(ev), col = "red3", lwd = 2)
legend("topright", "Valeur propre moyenne", lwd = 2, col = red3, bty = "n")
```

---
# Solution #4

```{r, echo = FALSE, fig.width=10, fig.height=7}
par(mar=c(4,4,2,1), cex = 1.2)
ev <- mite.spe.ca$CA$eig
n <- length(ev)
barplot(ev, main = "Valeurs propres", col = "grey", las = 2)
abline(h = mean(ev), col = "red3", lwd = 2)
legend("topright", "Valeur propre moyenne", lwd = 2, col = "red3", bty = "n")
```

---
# 4.3. Analyse en Coordonn√©es Principales

.center[![:scale 90%](images/Ord1.png)]

- En PCA, le maximum de la variation des donn√©es est pr√©serv√©e

- En PCoA, la distance entre objets est pr√©serv√©e autant que possible dans un espace multidimensionnel

.alert[ La PCoA est particuli√®rement consille pour des jeux de donn√©es plus larges que longs (probl√®me typique en g√©n√©tique)]

---
# PCoA - Essayons avec les donn√©es Poissons!

- Les fonctions `cmdscale()` et `pcoa()`, des librairies **stats** et **ape** permettent d'effectuer une PCoA:

```{R, include = FALSE}
library(ape)
```

```{r, eval = FALSE}
?cmdscale
library(ape)
?pcoa
```

- Effectuer une PCoA sur les abondances de poissons transform√©es Hellinger

```{r}
spe.h.pcoa <- pcoa(dist(spec.hel))
summary(spe.h.pcoa)
```


---
# PCoA - Interpr√©tation des sorties R

.center[![](images/PCoAInt.png)]


- Valeurs propres
- Valeurs propres relatives
- Mod√®le broken stick: √©value les axes significatifs
- Valeurs propres cumul√©es: cumul des valeurs propres relatives
- Broken stick cumul√©s: cumul des valeurs du mod√®le broken stick

---
# PCoA - Interpr√©tation des sorties R

![](images/PCoA2.png)

-Vecteurs : Vecteurs propres associ√©s √† chaque valeur propre contenant les coordonn√©es de chaque site dans l'espace euclidien.

.alert[Ce sont les r√©sultats les plus utiles pour des analyses subs√©quentes puisqu'ils capturent fid√®lement la distance entre objets. ]


---
# Biplot de PCoA avec `biplot.pcoa()`

La fonction `biplot.pcoa()` permet de visualiser en 2D les distances entre sites, et les esp√®ces associ√©es √† chaque site

```{r, fig.height=5, fig.width=8}
biplot.pcoa(spe.h.pcoa, spec.hel)
```


---
# PCoA et distances non-m√©triques

- La PCoA peut aussi √™tre utilis√©e pour capturer de l'information √† partir de distance non-m√©triques, telles que la distance de Bray-Curtis. Essayons :

```{r}
spe.bray.pcoa <- pcoa(spe.db.pa)
# spe.bray.pcoa
```

- Observer la sortie R et noter la pr√©sence de valeurs propres n√©gatives. Elles sont li√©es √† l'impossibilit√© de repr√©senter des distances non-m√©triques dans un espace euclidien sans corrections (*voir* Legendre & Legendre 2012) :

```{r}
spe.bray.pcoa <- pcoa(spe.db.pa, correction = "cailliez")
# spe.bray.pcoa
```

---
# PCoA et distances non-m√©triques

- Construisons maintenant le biplot (sans esp√®ces)

```{r, fig.width=6, fig.height=5.5, echo = -1}
par(mar=c(3,3,.5,1), cex = 1.2)
biplot.pcoa(spe.bray.pcoa)
```

---
# D√©fi #5 ![:cube]()

Ex√©cuter une PCoA sur les donn√©es d'abondances des esp√®ces d'acariens transform√©es Hellinger.

- Quels sont les axes importants?
- Quels groupes de sites pouvez-vous identifier?
- Quelles esp√®ces sont li√©es √† chaque groupe de sites?
- Comment les r√©sultats de cette PCoA se comparent-ils avec ceux de la PCA?

---
# Solution #5

- Transformation Hellinger pour les donn√©es esp√®ces
```{r}
mite.spe.hel <- decostand(mite.spe, method = "hellinger")
```

- Calcul de la PCoA

```{r}
mite.spe.h.pcoa <- pcoa(dist(mite.spe.hel))
```

---
# Solution #5

- Biplot pour visualiser les donn√©es:
```{r, fig.width=6, fig.height=6}
biplot.pcoa(mite.spe.h.pcoa, mite.spe.hel)
```


---
# Positionnement multidimensionnel non-m√©trique (NMDS)


- En PCA, CA et PCoA, les objets sont ordonn√©s dans un petit nombre de dimensions (i.e. axes) g√©n√©ralement > 2

- En cons√©quence, les biplots 2D ne repr√©sentent pas toute la variation pr√©sente dans les donn√©es.

- Parfois, l'objectif est cependant de repr√©senter les donn√©es dans un nombre d√©fini de dimensions.

- Comment effectuer une ordination pour illustrer l'ensemble de la variation des donn√©es ?

---
# Principe du NMDS

- NMDS
  - √©quivalent non-m√©trique de la PCoA
  - bas√© sur un algorithme it√©ratif d'optimisation pour identifier la meilleure repr√©sentation possible des donn√©es dans l'espace d'ordination
    de plus en plus populaire

- Dans un nMDS, l'utilisateur peut ainsi sp√©cifier:
  - le nombre de dimensions
  - la mesure de distance

---
# Effectuer un NMDS

-  La fonction `metaMDS()` de la librairie `vegan` permet de r√©aliser un NMDS
  - *distance* sp√©cifie la mesure de distance choisie
  - *k* sp√©cifie le nombre de dimensions

```{r}
spe.nmds <- metaMDS(spe, distance = 'bray', k = 2)
```

---
# NMDS : qualit√© de l'ajustement

- Le NMDS applique une proc√©dure it√©rative qui vise √† positionner les objets dans le nombre sp√©cifi√© de dimensions de fa√ßon √† minimiser une fonction de stress (variant de 0 √† 1) qui mesure la qualit√© de l'ajustement de la distance entre objets dans l'espace d'ordination.

- Ainsi, plus la valeur du stress sera faible, plus la repr√©sentation des objets dans l'espace d'ordination sera exacte.

---
# NMDS : qualit√© de l'ajustement

- La valeur de stress et le diagramme de Shepard peuvent √™tre obtenus avec :

```{r}
spe.nmds$stress
stressplot(spe.nmds, main = "Shepard plot")
```

---
# NMDS sur les donn√©es Poissons

- Effectuer le NMDS et v√©rifier la qualit√© de l'ajustement

```{r, eval = FALSE}
spe.nmds <- metaMDS(spe, distance = 'bray', k = 2)
spe.nmds$stress
stressplot(spe.nmds, main = "Shepard plot")
```

---
# NMDS sur les donn√©es Poissons

.pull-left[
![](images/ShepNMDS.png)
]

.pull-right[
- Le diagramme de Shepard identifie une forte corr√©lation entre les distances observ√©es et les distances de l'ordination (R2 > 0.95), et donc une bonne qualit√© de l'ajustement du NMDS.
]

---
# NMDS sur les donn√©es Poissons

- Construction du biplot

```{r, eval = FALSE}
plot(spe.nmds, type = "none",
     main = paste("NMDS/Bray - Stress =",
                  round(spe.nmds$stress, 3)),
     xlab = c("NMDS1"), ylab = "NMDS2")

points(scores(spe.nmds, display = "sites",
              choiches = c(1,2),
              pch = 21,
              col = "black",
              g = "steelblue",
              cex = 1.2))
text(scores(spe.nmds, display = "species", choices = c(1)),
            scores(spe.nmds, display = "species", choices = c(2)),
            labels = rownames(scores(spe.nmds, display = "species")),
            col = "red", cex = 0.8)
```

---
# NMDS sur les donn√©es Poissons

.pull-left[
Le biplot du nMDS identifie un groupe de sites caract√©ris√©es par les esp√®ces BLA, TRU, VAI, LOC, CHA et OMB, tandis que les autres esp√®ces caract√©risent un groupe de sites situ√©s dans le coin sup√©rieur droit du biplot.
]

.pull-right[
![](images/NMDSbiplot1.png)
]


---
# D√©fi #6 ![:cube]()

<br>

- Ex√©cuter un NMDS sur les donn√©es d'abondance des esp√®ces d'acariens en deux dimensions √† partir de distances de Bray-Curtis.

- √âvaluer la qualit√© de l'ajustement et interpr√©ter le biplot

---
# Solution #6

.pull-left[
![](images/SheplSol6.png)
]

.pull-right[
La corr√©lation entre distance observ√©e et distance d'ordination (R2 > 0.91) et la valeur de stress relativement faible identifient une bonne qualit√© de l'ajustement du NMDS.
]

---
# Solution #6

.pull-left[
![](images/NMDSSol61.png)
]

.pull-right[
Aucun groupe de sites ne peut √™tre pr√©cis√©ment identifi√© √† partir du biplot, ce qui montre que la plupart des esp√®ces sont pr√©sentes dans la plupart des sites.
]

---
# Conclusion

.alert[Beaucoup de m√©thodes d'ordination existent mais leurs sp√©cificit√©s doivent guider le choix de la m√©thode √† utiliser :]

|   | Distance preserv√©e | Variables | Nombre maximum d'axes |
|---|---------|--------------|------|
|PCA| Euclidienne | Donn√©es quantitatives, relation lin√©aires | p |
|CA| Chi2 | Non-n√©gatives, donn√©es quantitatives dimensionnellement homog√®nes, ou donn√©es binaires | p-1 |
|PCoA| D√©finie par l'utilisateur | Quantitatives, semi-quantitatives ou mixtes | p-1|
|NMDS| D√©finie par l'utilisateur | Quantitatives, semi-quantitatives ou mixtes | D√©finie par l'utilisateur |

---
# C'est l'heure du quiz !

.alert[Que signifie PCA?]

--

Principal Component Analysis

--

.alert[Laquelle de ces m√©thodes est la meilleure pour visualiser les *distances* entre composition des communaut√©s de diff√©rents sites?]

--

Principal Coordinate Analysis (PCoA)

--

.alert[Que repr√©sente une valeur propre dans une PCA ?]

--

La proportion de variance captur√©e par une composante principale

---
# C'est l'heure du quiz !

Trouvez l'erreur!

![:scale 90%](images/Chall7.png)

--
.alert[
- Donn√©es non centr√©es, Beurk!
]

---
# C'est l'heure du quiz !

Trouvez l'erreur!

![:scale 90%](images/Chall7_2.png)

--

.alert[
- Les 2 premiers axes capturent 100% de la variation
]


---
# Live Long and Ordinate

.center[![](images/LLaO.png)]

---
class: inverse, center, bottom

# Merci pour votre participation √† cet atelier!

![:scale 50%](images/qcbs_logo.png)
